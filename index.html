<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>晴チャット</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f2;
}

#header {
  background: #ffffff;
  padding: 12px;
  border-bottom: 1px solid #ddd;
  font-weight: bold;
}

#log {
  height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 10px;
}

.msg {
  margin: 8px 0;
  padding: 10px;
  border-radius: 12px;
  max-width: 80%;
  white-space: pre-wrap;
}

.me {
  background: #d4f4d7;
  margin-left: auto;
}

.bot {
  background: #ffffff;
  border: 1px solid #ddd;
}

#inputArea {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #ffffff;
  padding: 8px;
  display: flex;
  gap: 8px;
}

#msg {
  flex: 1;
  padding: 8px;
  resize: none;
  line-height: 1.4;
  max-height: 120px;
  overflow-y: auto;
  font-family: inherit;
  font-size: inherit;
}

button {
  padding: 8px 16px;
}

.timestamp {
  font-size: 11px;
  color: #999;
  margin: 6px 12px 2px 12px;
}

.timestamp.me {
  text-align: right;
}

.timestamp.bot {
  text-align: left;
}
</style>

</head>
<body>

<div id="header">晴 - chat</div>

<div id="sessions" style="padding:8px; background:#fafafa;"></div>
  
<div id="log"></div>
  
<div id="inputArea">
<textarea id="msg" rows="1" placeholder="ひさの言葉…"></textarea>
<button onclick="send()">送信</button>
<button onclick="newSession()">新規</button>  
</div>

<script>

const API_URL = "/api/chat";

// Enterで送信、Shift+Enterで改行
document.addEventListener("DOMContentLoaded", () => {
  const msg = document.getElementById("msg");

  msg.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send();
    }
  });

  // 入力に合わせてtextareaの高さを自動調整
  msg.addEventListener("input", () => {
    msg.style.height = "auto";
    msg.style.height = msg.scrollHeight + "px";
  });
});

let messages = [];

function append(role, text, timestamp=null) {

  const log = document.getElementById("log");

  if (timestamp) {
    const timeDiv = document.createElement("div");
    timeDiv.className =
      "timestamp " + (role === "user" ? "me" : "bot");
    const date = new Date(timestamp);
    timeDiv.textContent = date.toLocaleString("ja-JP");
    log.appendChild(timeDiv);
  }

  const div = document.createElement("div");
  div.className =
    "msg " + (role === "user" ? "me" : "bot");
  div.textContent = text;
  log.appendChild(div);

  log.scrollTop = log.scrollHeight;
}

async function send() {

  const input = document.getElementById("msg");
  const text = input.value.trim();
  if (!text) return;

  input.value = "";
  input.style.height = "auto";

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mode: "chat",
      messages: [
        { role: "user", content: text }
      ]
    })
  });

  const data = await res.json();

  // サーバーが返した完全ログで再描画
  document.getElementById("log").innerHTML = "";

  if (data.messages) {
    messages = data.messages;
    messages.forEach(m =>
      append(
        m.role,
        m.content,
        m.timestamp
      )
    );
  }
}
  
async function newSession() {

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "new" })
  });

  const data = await res.json();

  document.getElementById("log").innerHTML = "";
}
  
// 初期ロード（Redisからのみ）
fetch(API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ mode: "load" })
})
.then(r => r.json())
.then(data => {

  if (data.messages) {
    messages = data.messages;
    messages.forEach(m =>
      append(
        m.role,
        m.content,
        m.timestamp
      )
    );
  }

  loadSessions();

});


// セッション一覧読み込み
async function loadSessions() {

  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "list" })
  });

  const data = await res.json();

  const container = document.getElementById("sessions");
  container.innerHTML = "";

  if (!data.sessions) return;

  data.sessions.forEach(s => {

    const session = typeof s === "string"
      ? { id: s, name: s }
      : s;

    const btn = document.createElement("button");
    btn.textContent = session.name;

    btn.onclick = async () => {

      const res2 = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mode: "switch",
          sessionId: session.id
        })
      });

      const data2 = await res2.json();

      document.getElementById("log").innerHTML = "";

      if (data2.messages) {
        data2.messages.forEach(m =>
          append(m.role, m.content, m.timestamp)
        );
      }
    };

    container.appendChild(btn);
  });
}

</script>
</body>
</html>




