<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Êô¥„ÉÅ„É£„ÉÉ„Éà</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f2;
}

/* ===== Header ===== */
#header {
  background: #ffffff;
  padding: 10px 12px;
  border-bottom: 1px solid #ddd;
  font-weight: bold;

  position: sticky;
  top: 0;
  z-index: 20;

  display: flex;
  align-items: center;
  gap: 8px;
}

#menuBtn{
  display: inline-flex;
  align-items:center;
  justify-content:center;
  font-size: 22px;
  width: 44px;
  height: 44px;
  border: none;
  background: transparent;
  cursor: pointer;
}

/* ===== Chat Log ===== */
#log {
  height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 12px;
  box-sizing: border-box;
  padding-bottom: 220px; /* ÂÖ•ÂäõÊ¨Ñ„Å∂„ÇìÔºàJS„Åß„ÇÇË£úÊ≠£Ôºâ */
}

.msg {
  margin: 8px 0;
  padding: 10px 14px;
  border-radius: 14px;
  max-width: 80%;
  white-space: pre-wrap;
  line-height: 1.5;
}

.me {
  background: #d4f4d7;
  margin-left: auto;
}

.bot {
  background: #ffffff;
  border: 1px solid #ddd;
}

.timestamp {
  font-size: 11px;
  color: #999;
  margin: 4px 10px;
}
.timestamp.me { text-align: right; }
.timestamp.bot { text-align: left; }

/* ===== Input Area ===== */
#inputArea {
  position: fixed;
  left: 0;
  bottom: 0;
  width: 100%;
  background: #ffffff;
  border-top: 1px solid #ddd;
  padding: 10px;
  box-sizing: border-box;

  display: flex;
  gap: 8px;
  align-items: flex-end;
  z-index: 30;
}

#msg {
  flex: 1;
  min-height: 80px;
  max-height: 160px;
  resize: none;
  overflow-y: auto;
  padding: 12px;
  border-radius: 16px;
  border: 1px solid #ccc;
  box-sizing: border-box;
  font-size: 15px;
}

/* ÈÄÅ‰ø°„Éú„Çø„É≥Ôºà‰∏∏„Ç¢„Ç§„Ç≥„É≥Ôºâ */
#inputArea button {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: #10a37f;
  color: white;
  font-size: 18px;
  cursor: pointer;
  flex: 0 0 auto;
}

#inputArea button:hover { opacity: 0.9; }

/* ===== Sidebar (sessions) ===== */
#sidebarOverlay{
  display:none;
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.3);
  z-index: 40;
}

#sidebar{
  position: fixed;
  top:0; left:0; bottom:0;
  width: 260px;
  background: #ffffff;
  border-right: 1px solid #ddd;
  transform: translateX(-110%);
  transition: transform .2s ease;
  z-index: 50;
  padding: 10px;
  box-sizing: border-box;
}

#sidebar.open{ transform: translateX(0); }

#sidebar .title{
  font-weight: bold;
  margin: 6px 0 10px 0;
}

#sessionsInSidebar button{
  width: 100%;
  text-align: left;
  padding: 10px;
  margin: 6px 0;
  border-radius: 10px;
  border: 1px solid #ddd;
  background: #fafafa;
  cursor: pointer;
  color: #333;
}

/* PC„Åß„ÅØ„Çµ„Ç§„Éâ„Éê„ÉºÂ∏∏ÊôÇË°®Á§∫ */
@media (min-width: 768px){
  #sidebarOverlay{ display:none !important; }
  #sidebar{
    transform: translateX(0);
    z-index: 5;
  }
  #log{ margin-left: 260px; }
  #inputArea{
    left: 260px;
    width: calc(100% - 260px);
  }
}

.typing {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  color: #888;
}

.dot {
  animation: blink 1.4s infinite both;
}

.dot:nth-child(2) { animation-delay: .2s; }
.dot:nth-child(3) { animation-delay: .4s; }

.loadingBtn {
  background: #999 !important;
  cursor: not-allowed !important;
  opacity: 0.7;
}

@keyframes blink {
  0% { opacity: .2; }
  20% { opacity: 1; }
  100% { opacity: .2; }
}

</style>
</head>

<body>

<div id="sidebarOverlay" onclick="closeSidebar()"></div>

<div id="sidebar">
  <div class="title">„Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ß</div>
  <div id="sessionsInSidebar"></div>
  <div style="margin-top:10px;">
    <button onclick="newSession()" style="width:100%;height:44px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer;">
      Ôºã Êñ∞Ë¶è„Çª„ÉÉ„Ç∑„Éß„É≥
    </button>
  </div>
</div>

<div id="header">
  <button id="menuBtn" onclick="toggleSidebar()">‚ò∞</button>
  <span>Êô¥ - chat</span>
</div>

<div id="log"></div>

<div id="inputArea">
  <textarea id="msg" placeholder="„Å≤„Åï„ÅÆË®ÄËëâ‚Ä¶"></textarea>
  <button onclick="send()">‚û§</button>
</div>

<script>
const API_URL = "/api/chat";
let messages = [];

/* ===== Sidebar open/close ===== */
function toggleSidebar(){
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("sidebarOverlay");
  const isOpen = sidebar.classList.contains("open");
  if (isOpen){
    sidebar.classList.remove("open");
    overlay.style.display = "none";
  } else {
    sidebar.classList.add("open");
    overlay.style.display = "block";
  }
}

function closeSidebar(){
  document.getElementById("sidebar").classList.remove("open");
  document.getElementById("sidebarOverlay").style.display = "none";
}

/* ===== ÂÖ•ÂäõÊ¨ÑÈ´ò„ÅïËá™ÂãïË™øÊï¥ ===== */
document.addEventListener("DOMContentLoaded", () => {
  const msg = document.getElementById("msg");
  msg.addEventListener("input", () => {
    msg.style.height = "auto";
    msg.style.height = msg.scrollHeight + "px";
  });
});

/* ===== „É≠„Ç∞‰∏ã‰ΩôÁôΩËá™ÂãïË™øÊï¥ ===== */
(function(){
  const inputArea = document.getElementById("inputArea");
  const log = document.getElementById("log");
  function updatePadding(){
    log.style.paddingBottom = (inputArea.offsetHeight + 20) + "px";
  }
  new ResizeObserver(updatePadding).observe(inputArea);
  window.addEventListener("resize", updatePadding);
  updatePadding();
})();

/* ===== „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ ===== */
function append(role, text, timestamp=null) {
  const log = document.getElementById("log");

  if (timestamp) {
    const timeDiv = document.createElement("div");
    timeDiv.className = "timestamp " + (role === "user" ? "me" : "bot");
    timeDiv.textContent = new Date(timestamp).toLocaleString("ja-JP");
    log.appendChild(timeDiv);
  }

  const div = document.createElement("div");
  div.className = "msg " + (role === "user" ? "me" : "bot");
  div.textContent = text;
  log.appendChild(div);

  log.scrollTop = log.scrollHeight;
}

/* ===== ÈÄÅ‰ø°‰∏≠„Éª„Éª„ÉªË°®Á§∫ ===== */
function showTyping() {
  const log = document.getElementById("log");

  const div = document.createElement("div");
  div.className = "msg bot typing";
  div.id = "typingIndicator";
  div.innerHTML = `
    <span>Êô¥„ÅåÂÖ•Âäõ‰∏≠</span>
    <span class="dot">.</span>
    <span class="dot">.</span>
    <span class="dot">.</span>
  `;

  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function hideTyping() {
  const el = document.getElementById("typingIndicator");
  if (el) el.remove();
}

/* ===== ÈÄÅ‰ø°ÔºàEnter„ÅØÊîπË°å„ÄÇÈÄÅ‰ø°„ÅØ„Éú„Çø„É≥„ÅÆ„ÅøÔºâ ===== */
async function send() {

  const input = document.getElementById("msg");
  const btn = document.querySelector("#inputArea button");

  const text = input.value.trim();
  if (!text) return;

  // ‰∫åÈáçÈÄÅ‰ø°Èò≤Ê≠¢
  btn.disabled = true;
  btn.classList.add("loadingBtn");
  btn.textContent = "...";

  input.value = "";
  input.style.height = "auto";

  append("user", text, Date.now());
  showTyping();

  try {

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mode: "chat",
        messages: [{ role: "user", content: text }]
      })
    });

    if (!res.ok) {
      throw new Error("„Çµ„Éº„Éê„Éº„Ç®„É©„Éº");
    }

    const data = await res.json();

    document.getElementById("log").innerHTML = "";

    if (data.messages) {
      messages = data.messages;
      messages.forEach(m => append(m.role, m.content, m.timestamp));
    }

    loadSessions();

  } catch (err) {

    // üî• „Ç®„É©„ÉºË°®Á§∫
    hideTyping();

    const log = document.getElementById("log");
    const errorDiv = document.createElement("div");
    errorDiv.className = "msg bot";
    errorDiv.style.background = "#ffe5e5";
    errorDiv.style.border = "1px solid #ff9999";
    errorDiv.textContent = "ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ";

    log.appendChild(errorDiv);
    log.scrollTop = log.scrollHeight;

  } finally {

    // „Éú„Çø„É≥Âæ©Â∏∞
    btn.disabled = false;
    btn.classList.remove("loadingBtn");
    btn.textContent = "‚û§";

  }

}

/* ===== Êñ∞Ë¶è„Çª„ÉÉ„Ç∑„Éß„É≥ ===== */
async function newSession() {
  await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "new" })
  });

  document.getElementById("log").innerHTML = "";
  closeSidebar();
  loadSessions();
}

/* ===== ÂàùÊúü„É≠„Éº„Éâ ===== */
fetch(API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ mode: "load" })
})
.then(r => r.json())
.then(data => {
  if (data.messages) {
    messages = data.messages;
    messages.forEach(m => append(m.role, m.content, m.timestamp));
  }
  loadSessions();
});

/* ===== „Çª„ÉÉ„Ç∑„Éß„É≥‰∏ÄË¶ßË™≠„ÅøËæº„ÅøÔºà„Çµ„Ç§„Éâ„Éê„ÉºÔºâ ===== */
async function loadSessions() {
  const res = await fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ mode: "list" })
  });
  const data = await res.json();

  const side = document.getElementById("sessionsInSidebar");
  side.innerHTML = "";

  if (!data.sessions) return;

  data.sessions.forEach(s => {
    const session = typeof s === "string" ? { id: s, name: s } : s;

    const btn = document.createElement("button");
    btn.textContent = session.name;

    btn.onclick = async () => {
      const res2 = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mode: "switch", sessionId: session.id })
      });
      const data2 = await res2.json();

      document.getElementById("log").innerHTML = "";
      if (data2.messages) {
        data2.messages.forEach(m => append(m.role, m.content, m.timestamp));
      }
      closeSidebar();
    };

    side.appendChild(btn);
  });
}
</script>

</body>
</html>
