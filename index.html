<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>晴チャット</title>

<style>
body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f2;
}

#header {
  background: #ffffff;
  padding: 12px;
  border-bottom: 1px solid #ddd;
  font-weight: bold;
}

#log {
  height: calc(100vh - 120px);
  overflow-y: auto;
  padding: 10px;
}

.msg {
  margin: 8px 0;
  padding: 10px;
  border-radius: 12px;
  max-width: 80%;
  white-space: pre-wrap;
}

.me {
  background: #d4f4d7;
  margin-left: auto;
}

.bot {
  background: #ffffff;
  border: 1px solid #ddd;
}

#inputArea {
  position: fixed;
  bottom: 0;
  width: 100%;
  background: #ffffff;
  padding: 8px;
  display: flex;
  gap: 8px;
}

#msg {
  flex: 1;
  padding: 8px;
}

button {
  padding: 8px 16px;
}
</style>

</head>
<body>

<div id="header">晴 - hisa専用チャット</div>

<div id="log"></div>

<div id="inputArea">
<input id="msg" placeholder="ひさの言葉…">
<button onclick="send()">送信</button>
<button onclick="exportLog()">保存</button>
<button onclick="importLog()">読込</button>
<input type="file" id="fileInput" style="display:none">
</div>  

<script>

const API_URL = "/api/chat";
const STORAGE_KEY = "haru_chat_log_v1";

let messages = [];

function load() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    messages = JSON.parse(saved);
    messages.forEach(m => append(m.role, m.content, false));
  }
}

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(messages));
}

function append(role, text, saveFlag=true) {

  const div = document.createElement("div");
  div.className = "msg " + (role === "user" ? "me" : "bot");
  div.textContent = text;

  document.getElementById("log").appendChild(div);

  if (saveFlag) {
    messages.push({role, content:text});
    save();
  }

  document.getElementById("log").scrollTop = 999999;
}

async function send() {

  const input = document.getElementById("msg");
  const text = input.value.trim();

  if (!text) return;

  append("user", text);

  input.value = "";

  const res = await fetch(API_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      messages: messages
    })
  });

  const data = await res.json();

  append("assistant", data.reply);

}

load();

function exportLog() {

  const data = localStorage.getItem(STORAGE_KEY);

  const blob = new Blob([data], { type: "application/json" });

  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");

  a.href = url;

  a.download = "haru_chat_log.json";

  a.click();

}

function importLog() {

  const input = document.getElementById("fileInput");

  input.click();

  input.onchange = () => {

    const file = input.files[0];

    const reader = new FileReader();

    reader.onload = function() {

      localStorage.setItem(STORAGE_KEY, reader.result);

      location.reload();

    };

    reader.readAsText(file);

  };

}
  
</script>

<script type="module">

import { initializeApp }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";

import {
  getFirestore,
  doc,
  getDoc,
  setDoc
}
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


const firebaseConfig = {

  apiKey: "AIzaSyCqF7iPmI6VMbC-AsJZgY-8fFLMfJAtlRg",
  authDomain: "haru-chat-b1718.firebaseapp.com",
  projectId: "haru-chat-b1718",
  storageBucket: "haru-chat-b1718.appspot.com",
  messagingSenderId: "378629883584",
  appId: "1:378629883584:web:c430e4cc6e2de4c03bcf25"

};


const app = initializeApp(firebaseConfig);

const db = getFirestore(app);

const CLOUD_KEY = "haru_chat_cloud";


// クラウド保存
async function saveCloud(messages) {

  await setDoc(
    doc(db, "logs", CLOUD_KEY),
    { messages: messages }
  );

}


// クラウド読込
async function loadCloud() {

  const snap =
    await getDoc(doc(db, "logs", CLOUD_KEY));

  if (snap.exists()) {

    messages = snap.data().messages;

    localStorage.setItem(
      STORAGE_KEY,
      JSON.stringify(messages)
    );

    document.getElementById("log").innerHTML = "";

    messages.forEach(m =>
      append(m.role, m.content, false)
    );

  }

}


// 起動時にクラウドから読む
window.addEventListener("load", loadCloud);


// 保存時にクラウドにも保存
const originalSave = save;

save = function() {

  originalSave();

  const messages =
    JSON.parse(
      localStorage.getItem(STORAGE_KEY)
    );

  saveCloud(messages);

};

</script>
  
</body>
</html>

